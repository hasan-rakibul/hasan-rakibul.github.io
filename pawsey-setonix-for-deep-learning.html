<!DOCTYPE html>
<html lang="en-au">
<head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="generator" content="Pelican" />
        <title>Pawsey Setonix for deep learning</title>
        <link rel="stylesheet" href="/theme/css/main.css" />
        <meta name="description" content="Did you know 'Setonix' is actually the scientific name of Australian native animal 'Quokka'? I didn't know until I started using Pawsey's Setonix..." />
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Rakibul Hasan</a></h1>
                <nav><ul>
                    <li><a href="/">home</a></li>
                    <li><a href="/about_me.html">about me</a></li>
                    <li><a href="/publications.html">publications</a></li>
                    <li><a href="/activity.html">activity</a></li>
                    <li><a href="/blogs.html">blogs</a></li>
                    <li><a href="/links.html">links</a></li>
                    <li><a href="/student_corner.html">student corner</a></li>
                </ul></nav>
        </header><!-- /#banner -->
<section id="content" class="body">
  <article>
    <header>
      <h1 class="entry-title">
        <a href="/pawsey-setonix-for-deep-learning.html" rel="bookmark"
           title="Permalink to Pawsey Setonix for deep learning">Pawsey Setonix for deep learning</a></h1>
    </header>

    <div class="entry-content">
<footer class="post-info">
        <abbr class="published" title="2024-02-13T10:00:00+08:00">
                Published: Tue 13 February 2024
        </abbr>

        <!--         <address class="vcard author">
                By                         <a class="url fn" href="/author/rakibul-hasan.html">Rakibul Hasan</a>
        </address>
 -->
<!-- <p>In <a href="/category/blogs.html">blogs</a>.</p> -->

</footer><!-- /.post-info -->      <p>Did you know 'Setonix' is actually the scientific name of Australian native animal 'Quokka'? I didn't know until I started using Pawsey's Setonix for deep learning. This is a personal note to use Setnoix supercomputer for deep learning workflow. Please be informed that things might have changed since I last accessed and/or I might be mistaken on my notes.</p>
<h1>Constraints -- Must remember</h1>
<ul>
<li><code>/home</code> directory quota is 1GB.</li>
<li><code>/home</code> directory has inode quota of 10K.</li>
<li><code>/software/</code> directory has inode quota of 100K per user.</li>
<li><code>/scratch/</code> directory has inode quota of 1M per user.</li>
<li><code>/scratch/</code> files are deleted after 21 days of inactivity.</li>
</ul>
<h1>Access</h1>
<p>I access through VSCode remote SSH extension. It has a side-effect of hogging the small HOME quota, as mentioned <a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51931360/Visual+Studio+Code+for+Remote+Development">here</a>. To solve this, I can configure the remote SSH extension to use a different directory (e.g., <code>/scratch</code>) for the <code>.vscode-server</code> directory. Open the VSCode settings (Ctrl + ,) and search for "Server install path". Then, add items like this:</p>
<table>
<thead>
<tr>
<th>Item</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>setonix.pawsey.org.au</td>
<td><code>/scratch/&lt;project_id&gt;/&lt;user_id&gt;/</code></td>
</tr>
</tbody>
</table>
<p>Lately, the VSCode 1.93 version caused some issues with the above approach (details <a href="https://github.com/microsoft/vscode-remote-release/issues/10230">here</a>), so I had to revert to the default HOME directory, and created a symlink to the <code>.vscode-server</code> directory in the <code>/scratch</code> directory.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Open VSCode and connect to the remote server. It will create the .vscode-server directory in the HOME directory. Then, move it to the scratch directory and create a symlink.</span>
mv<span class="w"> </span>.vscode-server<span class="w"> </span>/scratch/pawsey1001/rakib/
ln<span class="w"> </span>-s<span class="w"> </span>/scratch/pawsey1001/rakib/.vscode-server<span class="w"> </span>.vscode-server
</code></pre></div>

<p>Next, just open the remote explorer and add a new SSH host. Then, select the host and connect. It will ask for the password and then it will be connected. To avoid password, we can use the public key authentication (detailed <a href="https://hasan-rakibul.github.io/personal-note-git-linux-etc-commands.html">here</a>).</p>
<h2>GPU Computing</h2>
<ul>
<li>Based on <a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51929056/Example+Slurm+Batch+Scripts+for+Setonix+on+GPU+Compute+Nodes">this</a>, SLURM command to access the GPU node interactively:</li>
</ul>
<div class="highlight"><pre><span></span><code>salloc<span class="w"> </span>-N<span class="w"> </span>&lt;n&gt;<span class="w"> </span>--gres<span class="o">=</span>gpu:&lt;n&gt;<span class="w"> </span>-A<span class="w"> </span>&lt;project_id&gt;-gpu<span class="w"> </span>--partition<span class="o">=</span>&lt;gpu<span class="w"> </span>or<span class="w"> </span>gpu-dev<span class="w"> </span>or<span class="w"> </span>gpu-highmem&gt;<span class="w"> </span>--time<span class="o">=</span>&lt;hh:mm:ss&gt;
ssh<span class="w"> </span>&lt;node_name&gt;<span class="w"> </span><span class="c1"># node_name is the name of the node you get from the previous command</span>
</code></pre></div>

<ul>
<li>Importants notes<ul>
<li>"Project name to access the GPU nodes is different." It is <code>&lt;project_id&gt;-gpu</code> instead of just <code>&lt;project_id&gt;</code>.</li>
<li>"The request of resources only needs the number of nodes (â€“-nodes, -N) and the number of allocation-packs per node (--gres=gpu:number)." "Users should not indicate any other Slurm allocation option related to memory or CPU cores. Therefore, users should not use --ntasks, --cpus-per-task, --mem, etc."</li>
</ul>
</li>
</ul>
<h2>Pytorch and Python</h2>
<ul>
<li>Guide: <a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51931230/PyTorch">here</a></li>
<li>The idea is that we need to build Pytorch (same for Tensoflow I think) from scratch to work with AMD GPUs on Setonix</li>
<li>To make it simpler, dockers and containers are available. We can load it throuch <code>docker pull</code> or <code>module load</code>. It didn't work well for me.</li>
</ul>
<h3>Pyenv</h3>
<ul>
<li>I really liked <a href="https://github.com/pyenv/pyenv">pyenv</a>, because the official pytorch container has several complexities and issues (details on next point). Pyenv seemed simpler to me.</li>
<li>To install ROCm-compatible Pytorch, I can follow the official pytorch guideline from <a href="https://pytorch.org/get-started/locally/">https://pytorch.org/get-started/locally/</a>, for example:</li>
</ul>
<div class="highlight"><pre><span></span><code>pip3<span class="w"> </span>install<span class="w"> </span>torch<span class="w"> </span>--index-url<span class="w"> </span>https://download.pytorch.org/whl/rocm6.0
</code></pre></div>

<h4>Offloading pyenv files in a different directory due to limited quota</h4>
<ul>
<li>The primary <code>.pyenv</code> is located in the home directory, which I symlinked to the <code>/software</code> directory. After symlinking, the <code>ls -al</code> shows <code>.pyenv -&gt; /software/projects/pawsey1001/rakib/.pyenv</code>. The command sequence of moving the files and symlinking may look like this:</li>
</ul>
<div class="highlight"><pre><span></span><code>mv<span class="w"> </span>.pyenv<span class="w"> </span>/software/projects/pawsey1001/rakib/
ln<span class="w"> </span>-s<span class="w"> </span>/software/projects/pawsey1001/rakib/.pyenv<span class="w"> </span>.pyenv
</code></pre></div>

<h5>Multiple virtual environments</h5>
<ul>
<li>It would be great if we could create virtual environment in a different folder. Following <a href="https://github.com/pyenv/pyenv-virtualenv/issues/408">this GitHub issue</a>, we can create virual envirornment using basic <code>python -m venv</code> command.</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="c1"># list available python versions using pyenv versions and see which one is active. Change if needed.</span>
python<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>&lt;path/to/venv&gt;<span class="w"> </span><span class="c1"># create a new virtual environment</span>
<span class="nb">source</span><span class="w"> </span>&lt;path/to/venv&gt;/bin/activate<span class="w"> </span><span class="c1"># activate the virtual environment</span>

<span class="c1"># Optional: Create symlink to change using pyenv</span>
<span class="nb">cd</span><span class="w"> </span>~/.pyenv/versions
ln<span class="w"> </span>-s<span class="w"> </span>&lt;path/to/venv&gt;<span class="w"> </span>env_name
pyenv<span class="w"> </span>activate<span class="w"> </span>env_name<span class="w"> </span><span class="c1"># activate the virtual environment</span>
</code></pre></div>

<h5>Unsuccessful experiments with pyenv</h5>
<ul>
<li>Even if I symlinked the environment folder, it seems the <code>lib</code> folder is common for all environments and thus getting quota error. <ul>
<li>If I need multiple virtual environment, it becomes more tricky. I thought of offloading files of less-significant environment to the <code>scratch</code> directory (as <code>scratch</code> has file purge policy, I would need to re-install packages after some days). After creating the new virtual environment, I symlinked corresponding virtual environment files to <code>scratch</code>. Inside <code>/home/rakib/.pyenv/versions/3.12.3/envs</code>, I symlinked the created virtual environment, which looks like: <code>env_name -&gt; /scratch/pawsey1001/rakib/extr_pyenv/env_name</code>.</li>
</ul>
</li>
<li>Even when I have multiple project allocations, I could not offload to another project's <code>software</code> directory (by symlinking) due to the inode quota being <strong>per user</strong>.</li>
</ul>
<h3>Pawsey-provided Pytorch</h3>
<div class="highlight"><pre><span></span><code>module<span class="w"> </span>load<span class="w"> </span>&lt;preferred_pytorch_version&gt;<span class="w"> </span><span class="c1"># e.g., pytorch/2.2.0-rocm5.7.3</span>
python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>&lt;path/to/venv&gt;<span class="w"> </span><span class="c1"># create a new virtual environment</span>
</code></pre></div>

<p><strong>There is a problem here.</strong> The symlinked Python version in the virtual environment is different from the loaded Pytorch. To verify, go to the <code>bin</code> directory of the virtual environment and run <code>ls -l</code>. It will show the symbolic link. An entry of <code>python3 -&gt; /usr/bin/python3</code> means the virtual environment is linked to the system Python, which we don't want. We can find the correct Python path using <code>which python3</code> command after loading the PyTorch module (for example: <code>/software/setonix/2023.08/containers/modules-long/quay.io/pawsey/pytorch/2.2.0-rocm5.7.3/bin/python3</code>). Then, to update the symlink, we can use the following command:</p>
<div class="highlight"><pre><span></span><code>ln<span class="w"> </span>-sf<span class="w"> </span>&lt;correct/path/to/python3&gt;<span class="w"> </span>&lt;path/to/venv&gt;/bin/python3<span class="w"> </span><span class="c1"># or, just python3 if you are in the bin directory</span>
</code></pre></div>

<p>Next, it should work as normal virtual environment. The next steps are:</p>
<div class="highlight"><pre><span></span><code><span class="nb">source</span><span class="w"> </span>&lt;path/to/venv&gt;/bin/activate<span class="w"> </span><span class="c1"># activate the virtual environment</span>
<span class="c1"># open &lt;path/to/venv&gt;/pyvenv.cfg and make &quot;include-system-site-packages = true&quot; to use the system packages, e.g., the loaded Pytorch</span>
<span class="c1"># Install new packages as usual. It will skip the packages exists from the loaded Pytorch container.</span>
</code></pre></div>

<p>Even with this approach, I failed to work with Jupyter notebook with virtual environment.</p>
<h3>Mamba/Conda</h3>
<ul>
<li>I have tried Miniforge3. It worked well initially, but there's no ROCm-compatible Pytorch available through conda/mamba. Installing through pip within conda environment could be a solution. Another problem was that the installation consumed the limited inode quota of <code>/software/</code> directory, and there's <code>disk quota exceeded</code> error frequently.</li>
</ul>
<h1>File system</h1>
<ul>
<li>As mentioned in <a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51929028/Setonix+General+Information">this Pawsey's documentation</a>,<ul>
<li><code>/software/projects/&lt;project_id&gt;/&lt;user_id&gt;/</code> to install software packages.</li>
<li><code>/scratch/&lt;project_id&gt;/&lt;user_id&gt;</code> for temporary storage.</li>
</ul>
</li>
</ul>
<h2>Limitation &ndash; /scratch files gets automatically deleted</h2>
<ul>
<li>As per Pawsey policy, files in <code>/scratch</code> are deleted automatically. The system checks the last access time of the files. Therefore, even if the files are copied recently, they will be deleted if their access timestamps are older than the specified days. <code>ls -ltu</code> can be used to check the access time of the files, sorted by access time. It is better to use <code>acacia</code> for long-term storage.</li>
</ul>
<h2>Acacia</h2>
<ul>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51924476/Acacia+-+Quick+Start">Quick start</a>. <strong>It's important to save the access keys key in the <code>$HOME/.config/rclone/rclone.conf</code> file.</strong> To do that, corresponding client configure command is available on the window after clicking the "Create New Key" button. Feel free to customise the profile name.</li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51924986/Acacia+-+User+Guide">User guide</a><ul>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51928144/Installing+an+S3+client+application">Install S3 client</a></li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51924480/Listing+the+contents+of+your+account">Listing the contents</a></li>
</ul>
</li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51924510/Acacia+-+Troubleshooting">Acacia - Troubleshooting</a><ul>
<li>"If copying to Setonix <code>/scratch</code> file system please be aware that rclone sets atime to the same as modtime (which it gets from the S3 storage).
This could result in data being purged from <code>/scratch</code> even though it has not been on the file system for 21 days.
To prevent this you can use the <code>--local-no-set-modtime</code> option to rclone."</li>
</ul>
</li>
</ul>
<h1>SLURM job submission</h1>
<ul>
<li><code>account</code> is the project ID, e.g., pawsey1234</li>
<li>Sample job submission script is <a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51927426/Example+Slurm+Batch+Scripts+for+Setonix+on+CPU+Compute+Nodes">here for CPU</a> and <a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51929056/Example+Slurm+Batch+Scripts+for+Setonix+on+GPU+Compute+Nodes">here for GPU</a>.</li>
</ul>
<h1>Important points</h1>
<ul>
<li>Home directory quota is 1GB only. Therefore, I should offload large files/folders from home to other directory. Especially, the <code>.cache</code>, <code>.local</code> and/or <code>.conda</code> files must be in another directory (e.g., <code>$MYSOFTWARE</code>). But please note that <code>/software/</code> has a smaller inode quota (mentioned in the top of this note).  Managing the cache and conda files through environment variable can be found <a href="https://hasan-rakibul.github.io/personal-note-git-linux-etc-commands.html">here</a>. Alternatively (<strong>Better</strong>), I can create symbolic links to those resource-intensive directories in the home directory.</li>
</ul>
<div class="highlight"><pre><span></span><code>mkdir<span class="w"> </span>-p<span class="w"> </span>.cache<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span><span class="nv">$MYSOFTWARE</span>/.cache<span class="w"> </span><span class="nv">$HOME</span>/.cache
mkdir<span class="w"> </span>-p<span class="w"> </span>.local<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>ln<span class="w"> </span>-s<span class="w"> </span><span class="nv">$MYSOFTWARE</span>/.local<span class="w"> </span><span class="nv">$HOME</span>/.local
</code></pre></div>

<ul>
<li>If there are multiple projects, configure default project name in <code>$HOME/.pawsey_project</code> to appropriately set <code>$MYSCRATCH</code> and <code>$MYSOFTWARE</code> environment variables.</li>
</ul>
<p>&nbsp;</p>
<h1>Important commands</h1>
<div class="highlight"><pre><span></span><code>pawseyAccountBalance<span class="w"> </span>-p<span class="w"> </span>pawsey1001-gpu<span class="w"> </span>-user<span class="w"> </span><span class="c1"># Check user-wise usage of GPU and CPU from a project</span>
pawseyAccountBalance<span class="w"> </span>-p<span class="w"> </span>pawsey1001-gpu<span class="w"> </span>-year<span class="w"> </span><span class="c1"># Check yearly usage of GPU and CPU from a project</span>
lfs<span class="w"> </span>quota<span class="w"> </span>/software<span class="w"> </span><span class="c1"># Check quota of the software directory, both user-wise and group-wise. Same can be checked for /scratch</span>
quota<span class="w"> </span>-s<span class="w"> </span><span class="c1"># Check the quota of the home directory</span>
du<span class="w"> </span>-sh<span class="w"> </span><span class="o">[</span>path<span class="o">]</span><span class="w"> </span><span class="c1"># Check the size of a directory, human-readable summary format</span>
ls<span class="w"> </span>--inode<span class="w"> </span>-sh<span class="w"> </span><span class="o">[</span>path<span class="o">]</span><span class="w"> </span><span class="c1"># Check the inode usage of a directory, human-readable summary format</span>
</code></pre></div>

<p>&nbsp;</p>
<h1>Course / Manuals / helpful resources</h1>
<ul>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51929028/Setonix+General+Information">https://pawsey.atlassian.net/wiki/spaces/US/pages/51929028/Setonix+General+Information</a></li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51925876/Pawsey+Filesystems+and+their+Usage">https://pawsey.atlassian.net/wiki/spaces/US/pages/51925876/Pawsey+Filesystems+and+their+Usage</a></li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51925880/Filesystem+Policies">https://pawsey.atlassian.net/wiki/spaces/US/pages/51925880/Filesystem+Policies</a></li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51925964/Job+Scheduling">https://pawsey.atlassian.net/wiki/spaces/US/pages/51925964/Job+Scheduling</a></li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51931360/Visual+Studio+Code+for+Remote+Development">https://pawsey.atlassian.net/wiki/spaces/US/pages/51931360/Visual+Studio+Code+for+Remote+Development</a></li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51927426/Example+Slurm+Batch+Scripts+for+Setonix+on+CPU+Compute+Nodes">https://pawsey.atlassian.net/wiki/spaces/US/pages/51927426/Example+Slurm+Batch+Scripts+for+Setonix+on+CPU+Compute+Nodes</a></li>
<li><a href="https://pawsey.atlassian.net/wiki/spaces/US/pages/51929056/Example+Slurm+Batch+Scripts+for+Setonix+on+GPU+Compute+Nodes">https://pawsey.atlassian.net/wiki/spaces/US/pages/51929056/Example+Slurm+Batch+Scripts+for+Setonix+on+GPU+Compute+Nodes</a></li>
</ul>
    </div><!-- /.entry-content -->

  </article>
</section>
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>find me on</h2>
                        <ul>
                            <li><a href="https://scholar.google.com.au/citations?user=DuCQ8goAAAAJ&hl=en">Google Scholar</a></li>
                            <li><a href="https://orcid.org/0000-0003-2565-5321">ORCiD</a></li>
                            <li><a href="https://www.researchgate.net/profile/Md-Rakibul-Hasan-10">ReserchGate</a></li>
                            <li><a href="https://www.semanticscholar.org/author/2142425">Semantic Scholar</a></li>
                            <li><a href="https://dblp.org/pid/122/5190-1.html">dblp</a></li>
                            <li><a href="https://arxiv.org/a/hasan_m_1.html">arXiv</a></li>
                            <li><a href="https://www.webofscience.com/wos/author/record/AFK-8839-2022">Web of Science</a></li>
                            <li><a href="https://www.linkedin.com/in/m-rakibul">LinkedIn</a></li>
                            <li><a href="https://github.com/hasan-rakibul">GitHub</a></li>
                            <li><a href="https://staffportal.curtin.edu.au/staff/profile/view/rakibul-hasan-145a1046/">Curtin University</a></li>
                            <li><a href="https://www.bracu.ac.bd/about/people/md-rakibul-hasan">BRAC University</a></li>
                            <li><a href="mailto:Rakibul.Hasan@curtin.edu.au">e-mail</a></li>
                        </ul>
                </div><!-- /.blogroll -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                        &copy; 2022 &ndash; 2024 Rakibul Hasan </br>
                        Proudly developed using <a href="https://getpelican.com/">Pelican</a>, which takes great advantage of <a href="https://www.python.org/">Python</a>.
                </address><!-- /#about -->

                <!-- <p>The theme is by <a href="https://www.smashingmagazine.com/2009/08/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p> -->
        </footer><!-- /#contentinfo -->



<!-- Added by RKBL to toggle BibTeX info and auto anchor tag on all pub list-->
<script>
        function generateId(entry) {
                // generating id for the toggle block
                return entry + "-bibtex";
        }

        function showBlock(blockId) {
                var codeBlock = document.getElementById(blockId);
                codeBlock.style.display = codeBlock.style.display === "block" ? "none" : "block";

                var button = document.getElementById(blockId+"-button"); <!--button ID is blockid-"button"-->
                button.classList.toggle("active");
        }

        // select all <li> elements
        var liElements = document.querySelectorAll('li[entry]');

        // iterate through <li> elements and set IDs
        liElements.forEach(function(li) {
                var entry = li.getAttribute('entry');

                if (entry) {

                        // create and set the anchor tag
                        var aElement = document.createElement('a');
                        aElement.name = entry;
                        li.insertBefore(aElement, li.firstChild);
                        // var aElement = li.querySelector('a');
                        
                        var preElement = li.querySelector('pre.toggle-block');

                        // if there is a preElement, set it's id
                        if (preElement) {
                                var blockId = generateId(entry);
                                preElement.id = blockId;
                        }
                }
        });
</script>

</body>
</html>